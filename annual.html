<!doctype html>
<html lang="ko" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì—°ì°¨íœ´ê°€ ê³„ì‚°ê¸° (ì…ì‚¬ì¼ ê¸°ì¤€ Â· íšŒê³„ì—°ë„ ê¸°ì¤€)</title>
<meta name="description" content="ì…ì‚¬ì¼/í‡´ì‚¬ì¼ì„ ì…ë ¥í•˜ë©´ ì—°ì°¨íœ´ê°€ê°€ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤. (ì…ì‚¬ì¼ ê¸°ì¤€, íšŒê³„ì—°ë„ ê¸°ì¤€ ë™ì‹œ í‘œì‹œ)" />
<style>
  :root{
    --bg:#f6f8fb; --surface:#fff; --line:#e5eaf0; --text:#0d1b2a; --muted:#516173;
    --title:#0a0f18; --accent:#2a66ff; --ring:rgba(42,102,255,.22);
    --sec-bg:#0a2a60; --sec-fg:#fff; --yellow:#fff9e6;
  }
  [data-theme="dark"]{
    --bg:#0a0e13; --surface:#0f1520; --line:#1f2a3a; --text:#eef4fb; --muted:#8ea4b8;
    --title:#fff; --accent:#62a8ff; --ring:rgba(98,168,255,.35);
    --sec-bg:#0a2a60; --sec-fg:#fff; --yellow:#2a2412;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,Helvetica,Arial,sans-serif}
  .appbar{position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center;justify-content:space-between;
    padding:12px 16px;background:var(--bg);border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(6px)}
  .brand{font-weight:800;color:var(--title)}
  .container{max-width:1100px;margin:24px auto 80px;padding:0 16px}
  .sheet{background:var(--surface);border:1px solid var(--line);border-radius:18px;overflow:hidden;
    box-shadow:0 8px 30px rgba(0,0,0,.08)}
  .sheet h1{margin:0;padding:18px;text-align:center;font-size:20px;font-weight:800;color:var(--title);
    border-bottom:1px solid var(--line);background:color-mix(in oklab, var(--surface) 92%, var(--bg))}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line);background:var(--surface)}
  .controls input[type="text"]{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:var(--surface);color:var(--text);
    outline:none;transition:.15s;box-shadow:0 0 0 0 var(--ring)}
  .controls input::placeholder{color:#9aa6b2}
  .controls input:focus{border-color:var(--accent);box-shadow:0 0 0 6px var(--ring)}
  .btn{border:1px solid var(--accent);border-radius:12px;padding:10px 12px;background:color-mix(in oklab, var(--accent) 12%, var(--surface));
    font-weight:700;cursor:pointer}
  .tables{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px}
  @media (max-width: 900px){ .tables{grid-template-columns:1fr} }
  .table-wrap{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:var(--surface)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{border-bottom:1px solid var(--line);padding:10px 10px;vertical-align:middle}
  th{background:color-mix(in oklab, var(--surface) 90%, var(--bg));font-weight:700}
  tr:last-child th, tr:last-child td{border-bottom:0}
  .sec-title{background:var(--sec-bg)!important;color:var(--sec-fg)!important;text-align:left;font-weight:800}
  .right{text-align:right}
  .mono{font-variant-numeric:tabular-nums}
  .yellow{background:var(--yellow)}

  /* í‘œ ì•ˆ ìˆ«ì ì…ë ¥ */
  .num-input{
    width:100%; text-align:right; padding:6px 8px;
    border:1px solid var(--line); border-radius:8px; background:var(--surface); color:var(--text);
  }
  .num-input:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 4px var(--ring)}
  .note{padding:10px 16px;border-top:1px solid var(--line);color:var(--muted);font-size:13px}
  .subtle{color:var(--muted);font-size:12px}
  label.chk{display:inline-flex;align-items:center;gap:6px}
</style>
</head>
<body>
  <div class="appbar">
    <div class="brand">ì—°ì°¨íœ´ê°€ ê³„ì‚°ê¸°</div>
    <div>
      <button id="themeBtn" class="btn" type="button">ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</button>
    </div>
  </div>

  <div class="container">
    <div class="sheet">
      <h1>ì—°ì°¨íœ´ê°€ ê³„ì‚°ê¸° (ì…ì‚¬ì¼ ê¸°ì¤€ Â· íšŒê³„ì—°ë„ ê¸°ì¤€)</h1>

      <!-- ì…ë ¥ ì˜ì—­ -->
      <div class="controls">
        <label>ì…ì‚¬ì¼ <input id="joinDate" type="text" placeholder="yyyy-mm-dd" data-next="leaveDate"></label>
        <label>í‡´ì‚¬ì¼ <input id="leaveDate" type="text" placeholder="yyyy-mm-dd"></label>
        <label class="chk"><input type="checkbox" id="pre20170529"> 2017-05-29 ì´ì „ ì…ì‚¬ì</label>
        <button id="calcBtn" class="btn">ê³„ì‚°</button>
        <span class="subtle">ë‚ ì§œëŠ” 8ìë¦¬(ì˜ˆ: 20240712)ë§Œ ì…ë ¥í•´ë„ ë©ë‹ˆë‹¤.</span>
      </div>

      <div class="tables">
        <!-- íšŒê³„ì—°ë„ ê¸°ì¤€ -->
        <div class="table-wrap">
          <table id="tblFiscal">
            <tr><th class="sec-title" colspan="5">ì—°ì°¨íœ´ê°€ ê³„ì‚°ê¸° (íšŒê³„ì—°ë„ ê¸°ì¤€)</th></tr>
            <tr>
              <th style="width:20%">êµ¬ë¶„</th>
              <th class="yellow">ë°œìƒì¼ì</th>
              <th class="yellow right">ë°œìƒì¼ìˆ˜</th>
              <th>ê¸° ì‚¬ìš©ì¼ìˆ˜</th>
              <th>ê¸° ë³´ìƒì¼ìˆ˜</th>
            </tr>
            <tbody id="fiscalBody"></tbody>
            <tr>
              <th>í•©ê³„</th>
              <td class="yellow"></td>
              <td class="yellow right mono" id="fiscalSum">0</td>
              <td class="right mono" id="fiscalUsedSum">0</td>
              <td class="right mono" id="fiscalCompSum">0</td>
            </tr>
          </table>
        </div>

        <!-- ì…ì‚¬ì¼ ê¸°ì¤€ -->
        <div class="table-wrap">
          <table id="tblAnniv">
            <tr><th class="sec-title" colspan="5">ì—°ì°¨íœ´ê°€ ê³„ì‚°ê¸° (ì…ì‚¬ì¼ ê¸°ì¤€)</th></tr>
            <tr>
              <th style="width:20%">ê·¼ì†ë…„ìˆ˜</th>
              <th class="yellow">ë°œìƒì¼ì</th>
              <th class="yellow right">ë°œìƒì¼ìˆ˜</th>
              <th>ê¸° ì‚¬ìš©ì¼ìˆ˜</th>
              <th>ê¸° ë³´ìƒì¼ìˆ˜</th>
            </tr>
            <tbody id="annivBody"></tbody>
            <tr>
              <th>í•©ê³„</th>
              <td class="yellow"></td>
              <td class="yellow right mono" id="annivSum">0</td>
              <td class="right mono" id="annivUsedSum">0</td>
              <td class="right mono" id="annivCompSum">0</td>
            </tr>
          </table>
        </div>
      </div>

      <div class="note">
      </div>
    </div>
  </div>

<script>
/* ===== Theme toggle ===== */
(function(){
  const saved = localStorage.getItem('theme'); if(saved) document.documentElement.setAttribute('data-theme', saved);
  updateThemeBtn();
})();
function updateThemeBtn(){
  const dark = document.documentElement.getAttribute('data-theme')==='dark';
  document.getElementById('themeBtn').textContent = dark ? 'â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ ëª¨ë“œ';
}
document.getElementById('themeBtn').addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'light';
  const next = cur==='light' ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  updateThemeBtn();
});

/* ===== Date input: 20240712 -> 2024-07-12 ===== */
function toYmd(val){
  const v=(val||'').replace(/\D/g,''); if(v.length!==8) return null;
  const y=v.slice(0,4), m=v.slice(4,6), d=v.slice(6,8);
  const mm=+m, dd=+d; if(mm<1||mm>12||dd<1||dd>31) return null;
  return `${y}-${m}-${d}`;
}
['joinDate','leaveDate'].forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener('input', ()=>{
    const fm=toYmd(el.value); if(fm){ el.value=fm; }
  });
});

/* ===== Date helpers ===== */
const dt = s => new Date(s);
const fmtDate = d => d.toISOString().slice(0,10);
function addMonths(date, n){
  const d=new Date(date); const day=d.getDate();
  d.setMonth(d.getMonth()+n);
  if(d.getDate()<day){ d.setDate(0); }
  return d;
}
function addYears(date, n){
  const d=new Date(date); d.setFullYear(d.getFullYear()+n); return d;
}
function daysInclusive(a,b){
  const A = (a instanceof Date) ? a : new Date(a);
  const B = (b instanceof Date) ? b : new Date(b);
  return Math.max(0, Math.floor((B - A) / 86400000) + 1);
}

/* ===== Business logic ===== */

// 1ë…„ ë¯¸ë§Œ ì›”ì°¨
function monthlyAccruals(join, leave){
  const firstAnniv = addYears(join,1);
  const end = leave && leave<firstAnniv ? leave : firstAnniv;
  const dates=[];
  let cur = addMonths(join,1);
  while(cur <= end){
    dates.push(new Date(cur));
    cur = addMonths(cur,1);
  }
  return dates.filter(d => d < firstAnniv && (!leave || d<=leave));
}

// ì •ê¸°ì—°ì°¨ ì¼ìˆ˜: n=1 â†’ 15, n=2 â†’ 15, n=3~ â†’ 16,17, â€¦ ìƒí•œ 25
function regularDaysByYearN(n){
  return Math.min(25, 15 + Math.floor((n-1)/2));
}

/* ===== Rendering helpers ===== */
function clearTbody(tbody){ while(tbody.firstChild) tbody.removeChild(tbody.firstChild); }
function tr(cells){ const tr=document.createElement('tr'); cells.forEach(td=>tr.appendChild(td)); return tr; }
function th(text){ const el=document.createElement('th'); el.textContent=text; return el; }
function td(text, cls=''){ const el=document.createElement('td'); el.textContent=text; if(cls) el.className=cls; return el; }

/* â€œê¸° ì‚¬ìš©/ë³´ìƒâ€ ì…€ ìƒì„±: typeTagë¡œ íŠ¹ë¡€ êµ¬ê°„ ì‹ë³„ */
function usedCompCells(baseDays, typeTag, tableTag){
  const usedTd = document.createElement('td');
  const inp = document.createElement('input');
  inp.type = 'number'; inp.min = '0'; inp.step = '0.1';
  inp.value = '0'; inp.className = 'num-input mono';
  inp.dataset.basedays = String(baseDays);
  inp.dataset.typetag = typeTag;   // ì˜ˆ: fiscal-y1, fiscal-y2carry, anniv-under1, anniv-regular
  inp.dataset.tabletag = tableTag; // fiscal / anniv
  usedTd.appendChild(inp);

  const compTd = document.createElement('td');
  compTd.className = 'right mono';
  compTd.textContent = baseDays.toFixed(1);
  compTd.dataset.basedays = String(baseDays);
  compTd.dataset.typetag = typeTag;
  compTd.dataset.tabletag = tableTag;

  return [usedTd, compTd];
}

/* í•©ê³„ ì¬ê³„ì‚° */
function recalcSums(){
  ['fiscal','anniv'].forEach(tag=>{
    const sumBase = [...document.querySelectorAll(`tbody#${tag==='fiscal'?'fiscalBody':'annivBody'} td.yellow.right`)]
      .reduce((a,el)=>a + (parseFloat(el.textContent)||0), 0);
    document.getElementById(tag==='fiscal'?'fiscalSum':'annivSum').textContent = (Math.round(sumBase*10)/10).toString();

    const usedSum = [...document.querySelectorAll(`tbody#${tag==='fiscal'?'fiscalBody':'annivBody'} input.num-input`)]
      .reduce((a,el)=>a + (parseFloat(el.value)||0), 0);
    document.getElementById(tag==='fiscal'?'fiscalUsedSum':'annivUsedSum').textContent = (Math.round(usedSum*10)/10).toString();

    const compSum = [...document.querySelectorAll(`tbody#${tag==='fiscal'?'fiscalBody':'annivBody'} td.right.mono`)]
      .filter(el=>!el.classList.contains('yellow'))
      .reduce((a,el)=>a + (parseFloat(el.textContent)||0), 0);
    document.getElementById(tag==='fiscal'?'fiscalCompSum':'annivCompSum').textContent = (Math.round(compSum*10)/10).toString();
  });
}

/* ì‚¬ìš© â†” ë³´ìƒ ì—°ê²° + íŠ¹ë¡€ ì ìš© */
function wireUsedListeners(){
  const isLegacy = document.getElementById('pre20170529').checked;

  document.querySelectorAll('input.num-input').forEach(inp=>{
    const compTd = inp.parentElement.nextElementSibling;
    const base = parseFloat(inp.dataset.basedays)||0;
    const type = inp.dataset.typetag; // fiscal-y1, fiscal-y2carry, fiscal-y2prorate, anniv-under1, anniv-regular

    function updateComp(){
      let comp;
      // íŠ¹ë¡€: 2017-05-29 ì´ì „ ì…ì‚¬ì
      if(isLegacy && (type==='fiscal-y1' || type==='fiscal-y2carry' || type==='anniv-under1')){
        comp = base;  // ì‚¬ìš©ê³¼ ë¬´ê´€í•˜ê²Œ ë°œìƒ=ë³´ìƒ
      }else{
        const used = parseFloat(inp.value)||0;
        comp = Math.max(0, base - used);
      }
      compTd.textContent = (Math.round(comp*10)/10).toString();
      recalcSums();
    }

    // ì´ˆê¸° ê³„ì‚° ë° ì´ë²¤íŠ¸
    updateComp();
    inp.addEventListener('input', updateComp);
  });
}

/* ===== Main calc ===== */
function calc(){
  const jStr=document.getElementById('joinDate').value;
  const lStr=document.getElementById('leaveDate').value;
  if(!jStr) return;
  const join = dt(jStr);
  const leave = lStr ? dt(lStr) : null;
  const isLegacy = document.getElementById('pre20170529').checked;

  /* ì…ì‚¬ì¼ ê¸°ì¤€ */
  const aBody=document.getElementById('annivBody');
  clearTbody(aBody);
  let annivSum=0;

  // 1ë…„ ë¯¸ë§Œ ì›”ì°¨
  const mDates = monthlyAccruals(join, leave);
  if(mDates.length){
    const firstMonthLabel = `ë§¤ì›” ${String(join.getDate()).padStart(2,'0')}ì¼`;
    const base = mDates.length * 1.0;
    const [usedTd, compTd] = usedCompCells(parseFloat(base.toFixed(1)), 'anniv-under1', 'anniv');
    aBody.appendChild(tr([
      th('1ë…„ ë¯¸ë§Œ'),
      td(firstMonthLabel,'yellow'),
      td(base.toFixed(1),'yellow right mono'),
      usedTd,
      compTd,
    ]));
    annivSum += base;
  }

  // ì •ê¸°ì—°ì°¨ (ë§Œ1ë…„ ì´í›„)
  let n=1;
  let genDate = addYears(join,1);
  while(!leave || genDate <= leave){
    const days = regularDaysByYearN(n);
    const base = parseFloat(days.toFixed(1));
    const [usedTd, compTd] = usedCompCells(base, 'anniv-regular', 'anniv');
    aBody.appendChild(tr([
      th(`${n}ë…„ê·¼ì†`),
      td(fmtDate(genDate),'yellow'),
      td(base.toFixed(1),'yellow right mono'),
      usedTd,
      compTd,
    ]));
    annivSum += base;
    n++; genDate = addYears(genDate,1);
    if(n>50) break;
  }
  document.getElementById('annivSum').textContent = (Math.round(annivSum*10)/10).toString();

  /* íšŒê³„ì—°ë„ ê¸°ì¤€ */
  const fBody=document.getElementById('fiscalBody');
  clearTbody(fBody);
  let fiscalSum=0;

  const firstAnniv = addYears(join,1);

  // 1ë…„ì°¨(ì…ì‚¬ì—°ë„ ë‚´ ì›”ì°¨)
  const monthsAll = monthlyAccruals(join, leave);
  const monthsY1  = monthsAll.filter(d=> d.getFullYear()===join.getFullYear());
  const monthsCarry = monthsAll.filter(d=> d.getFullYear()!==join.getFullYear());

  const monthLabel = `ë§¤ì›” ${String(join.getDate()).padStart(2,'0')}ì¼`;
  // 1ë…„ì°¨
  {
    const base = parseFloat(monthsY1.length.toFixed(1));
    const [usedTd, compTd] = usedCompCells(base, 'fiscal-y1', 'fiscal');
    fBody.appendChild(tr([
      th('1ë…„ì°¨'),
      td(monthLabel,'yellow'),
      td(base.toFixed(1),'yellow right mono'),
      usedTd,
      compTd,
    ]));
    fiscalSum += base;
  }
  // 2ë…„ì°¨ @ (carry)
  {
    const base = parseFloat(monthsCarry.length.toFixed(1));
    const [usedTd, compTd] = usedCompCells(base, 'fiscal-y2carry', 'fiscal');
    fBody.appendChild(tr([
      th('2ë…„ì°¨ @'),
      td(monthLabel,'yellow'),
      td(base.toFixed(1),'yellow right mono'),
      usedTd,
      compTd,
    ]));
    fiscalSum += base;
  }

  // 2ë…„ì°¨ ì •ê¸°ì—°ì°¨(ë¹„ë¡€)
  const endPrevYear = new Date(join.getFullYear(), 11, 31);
  let prorateDays = 0;
  if (endPrevYear >= join) {
    const serviceDaysPrev = daysInclusive(join, endPrevYear);
    const raw = (serviceDaysPrev / 365) * 15;
    prorateDays = Math.ceil(raw * 10) / 10; // ë‘˜ì§¸ìë¦¬ ì˜¬ë¦¼ â†’ 1ìë¦¬ í‘œì‹œ
  }
  {
    const base = parseFloat(prorateDays.toFixed(1));
    const [usedTd, compTd] = usedCompCells(base, 'fiscal-y2prorate', 'fiscal');
    fBody.appendChild(tr([
      th('2ë…„ì°¨(ë¹„ë¡€ì—°ì°¨)'),
      td(`${firstAnniv.getFullYear()}-01-01`,'yellow'),
      td(base.toFixed(1),'yellow right mono'),
      usedTd,
      compTd,
    ]));
    fiscalSum += base;
  }

  // 3ë…„ì°¨ë¶€í„° ì˜¨ì „íˆ ë°œìƒ
  let fyYear = firstAnniv.getFullYear()+1;
  let fyN = 2; // ì •ê¸°ì—°ì°¨ N: 1=2ë…„ì°¨, 2=3ë…„ì°¨ â€¦
  let fyDate = addYears(firstAnniv, 1);
  while(!leave || fyDate <= leave){
    const days = regularDaysByYearN(fyN);
    const base = parseFloat(days.toFixed(1));
    const [usedTd, compTd] = usedCompCells(base, 'fiscal-regular', 'fiscal');
    fBody.appendChild(tr([
      th(`${fyN+1}ë…„ì°¨`),
      td(`${fyYear}-01-01`,'yellow'),
      td(base.toFixed(1),'yellow right mono'),
      usedTd,
      compTd,
    ]));
    fiscalSum += base;
    fyN++; fyYear++; fyDate = addYears(fyDate,1);
    if(fyN>50) break;
  }

  document.getElementById('fiscalSum').textContent = (Math.round(fiscalSum*10)/10).toString();

  // ì‚¬ìš© â†” ë³´ìƒ ì—°ë™ & íŠ¹ë¡€ ì ìš©
  wireUsedListeners();
  recalcSums();
}

document.getElementById('calcBtn').addEventListener('click', calc);
/* íŠ¹ë¡€ í† ê¸€ ë³€ê²½ ì‹œì—ë„ ì¬ê³„ì‚° */
document.getElementById('pre20170529').addEventListener('change', ()=>{
  // ë³´ìƒì¼ìˆ˜ ì¬ê³„ì‚°ë§Œ ë‹¤ì‹œ
  wireUsedListeners();
  recalcSums();
});
</script>
</body>
</html>
