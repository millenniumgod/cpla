 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/annual.html b/annual.html
index 285acf21a183d692fcea1006310260d463046dfb..f0257921880daa81ea458dce46e5a0e508d795ef 100644
--- a/annual.html
+++ b/annual.html
@@ -235,71 +235,91 @@ document.getElementById('navSelect').addEventListener('change', e=>{
   if(saved) document.documentElement.setAttribute('data-theme', saved);
   updateThemeBtn();
 })();
 function updateThemeBtn(){
   const dark = document.documentElement.getAttribute('data-theme')==='dark';
   document.getElementById('themeBtn').textContent = dark ? 'â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ ëª¨ë“œ';
 }
 document.getElementById('themeBtn').addEventListener('click', ()=>{
   const cur = document.documentElement.getAttribute('data-theme') || 'light';
   const next = cur==='light' ? 'dark' : 'light';
   document.documentElement.setAttribute('data-theme', next);
   localStorage.setItem('theme', next);
   updateThemeBtn();
 });
 
 /* ===== Date input helper ===== */
 function toYmd(val){
   const v=(val||'').replace(/\D/g,''); if(v.length!==8) return null;
   const y=v.slice(0,4), m=v.slice(4,6), d=v.slice(6,8);
   const mm=+m, dd=+d; if(mm<1||mm>12||dd<1||dd>31) return null;
   return `${y}-${m}-${d}`;
 }
 ['joinDate','leaveDate'].forEach(id=>{
   const el=document.getElementById(id);
   el.addEventListener('input', ()=>{ const fm=toYmd(el.value); if(fm) el.value=fm; });
+  el.addEventListener('keydown', e=>{
+    if(e.key==='Enter'){
+      e.preventDefault();
+      calc();
+    }
+  });
 });
 
 /* ===== Helpers ===== */
-const dt = s => new Date(s);
-const fmtDate = d => d.toISOString().slice(0,10);
+function dt(s){
+  if(!s) return new Date(NaN);
+  if(typeof s === 'string' && /\d{4}-\d{2}-\d{2}/.test(s)){
+    const [y,m,d] = s.split('-').map(Number);
+    return new Date(y, m-1, d);
+  }
+  return new Date(s);
+}
+function fmtDate(date){
+  const d = new Date(date);
+  const y = d.getFullYear();
+  const m = String(d.getMonth()+1).padStart(2,'0');
+  const day = String(d.getDate()).padStart(2,'0');
+  return `${y}-${m}-${day}`;
+}
 function addMonths(date, n){
   const d=new Date(date); const day=d.getDate();
   d.setMonth(d.getMonth()+n);
   if(d.getDate()<day){ d.setDate(0); }
   return d;
 }
 function addYears(date, n){ const d=new Date(date); d.setFullYear(d.getFullYear()+n); return d; }
 function daysInclusive(a,b){ const A=(a instanceof Date)?a:new Date(a); const B=(b instanceof Date)?b:new Date(b); return Math.max(0, Math.floor((B - A) / 86400000) + 1); }
+function endOfDay(date){ const d=new Date(date); d.setHours(23,59,59,999); return d; }
 
 /* ===== Logic ===== */
-function monthlyAccruals(join, leave){
+function monthlyAccruals(join, leaveLimit){
   const firstAnniv = addYears(join,1);
-  const end = (leave && leave<firstAnniv) ? leave : firstAnniv;
+  const end = (leaveLimit && leaveLimit<firstAnniv) ? leaveLimit : firstAnniv;
   const arr=[]; let cur=addMonths(join,1);
   while(cur<=end){ arr.push(new Date(cur)); cur=addMonths(cur,1); }
-  return arr.filter(d => d < firstAnniv && (!leave || d<=leave));
+  return arr.filter(d => d < firstAnniv && (!leaveLimit || d<=leaveLimit));
 }
 // ì •ê¸°ì—°ì°¨(ì…ì‚¬ì¼ ê¸°ì¤€): n=1â†’15(2ë…„ì°¨), n=2â†’15(3ë…„ì°¨), n=3â†’16(4Â·5ë…„ì°¨)â€¦ ìƒí•œ 25
 function regularDaysByYearN(n){ return Math.min(25, 15 + Math.floor((n-1)/2)); }
 /* íšŒê³„ì—°ë„ í‘œì‹œ ê¸°ì¤€: 3Â·4ë…„ì°¨=15, 5ë…„ì°¨ë¶€í„° ê°€ì‚°(5Â·6=16, 7Â·8=17 â€¦ ìƒí•œ 25) */
 function fiscalDaysByDisplayYear(y){
   if(y<=4) return 15;
   const add=Math.floor((y-3)/2);
   return Math.min(25, 15 + add);
 }
 
 /* ===== Rendering helpers ===== */
 function clearTbody(tbody){ while(tbody.firstChild) tbody.removeChild(tbody.firstChild); }
 function tr(cells){ const r=document.createElement('tr'); cells.forEach(c=>r.appendChild(c)); return r; }
 function th(text){ const e=document.createElement('th'); e.textContent=text; return e; }
 function td(text, cls=''){ const e=document.createElement('td'); e.textContent=text; if(cls) e.className=cls; return e; }
 
 /* ì…ë ¥/ë³´ìƒ ì…€ */
 function usedCompCells(baseDays, typeTag, isLegacy){
   const usedTd=document.createElement('td');
   const inp=document.createElement('input');
   inp.type='number'; inp.min='0'; inp.step='0.1'; inp.value='0'; inp.className='num-input mono right';
   usedTd.appendChild(inp);
 
   const compTd=document.createElement('td'); compTd.className='right mono';
 
@@ -321,121 +341,122 @@ function usedCompCells(baseDays, typeTag, isLegacy){
 }
 
 /* í•©ê³„ ì§‘ê³„ */
 function recalcSums(){
   [['fiscalBody','fiscalSum','fiscalUsedSum','fiscalCompSum'],
    ['annivBody','annivSum','annivUsedSum','annivCompSum']].forEach(([tbodyId,sumId,usedId,compId])=>{
     const tbody=document.getElementById(tbodyId);
 // ë…¸ë€ìƒ‰ + ì˜¤ë¥¸ìª½ì •ë ¬(=ìˆ«ì ì…€)ë§Œ ì§‘ê³„
     const base = [...tbody.querySelectorAll('td.yellow.right')].reduce((a, e) => a + (parseFloat(e.textContent) || 0), 0);
     const used=[...tbody.querySelectorAll('input.num-input')].reduce((a,e)=>a+(parseFloat(e.value)||0),0);
     const comp=[...tbody.querySelectorAll('tr')].reduce((a,row)=>{
       const last=row.querySelector('td:last-child'); return a+(last?(parseFloat(last.textContent)||0):0);
     },0);
     document.getElementById(sumId).textContent = base.toFixed(1);
     document.getElementById(usedId).textContent = used.toFixed(1);
     document.getElementById(compId).textContent = comp.toFixed(1);
   });
 }
 
 /* ===== Main calc ===== */
 function calc(){
   const jStr=document.getElementById('joinDate').value;
   const lStr=document.getElementById('leaveDate').value;
   if(!jStr) return;
   const join=dt(jStr), leave=lStr?dt(lStr):null;
+  const leaveLimit = leave ? endOfDay(leave) : null;
 
   // 2017-05-29 ì´ì „ ìë™ íŠ¹ë¡€
   const isLegacy = join < new Date('2017-05-29');
 
   /* ---- ì…ì‚¬ì¼ ê¸°ì¤€ ---- */
   const aBody=document.getElementById('annivBody'); clearTbody(aBody);
   let aSum=0;
 
   // 1ë…„ ë¯¸ë§Œ
-  const mDates=monthlyAccruals(join, leave);
+  const mDates=monthlyAccruals(join, leaveLimit);
   if(mDates.length){
     const label=`ë§¤ì›” ${String(join.getDate()).padStart(2,'0')}ì¼`;
     const base=mDates.length*1.0;
     const [u,c]=usedCompCells(base,'anniv-under1',isLegacy);
     aBody.appendChild(tr([ th('1ë…„ ë¯¸ë§Œ'), td(label,'yellow'), td(base.toFixed(1),'yellow right mono'), u, c ]));
     aSum += base;
   }
 
   // ë§Œ 1ë…„ ì´í›„ ì •ê¸°ì—°ì°¨ (ì…ì‚¬ì¼ ê¸°ì¤€)
   let n=1, genDate=addYears(join,1);
-  while(!leave || genDate<=leave){
+  while(!leaveLimit || genDate<=leaveLimit){
     const days=regularDaysByYearN(n);
     const base=days*1.0;
     const [u,c]=usedCompCells(base,'anniv-regular',isLegacy);
     aBody.appendChild(tr([ th(`${n}ë…„ê·¼ì†`), td(fmtDate(genDate),'yellow'), td(base.toFixed(1),'yellow right mono'), u, c ]));
     aSum += base;
     n++; genDate=addYears(genDate,1);
     if(n>50) break;
   }
   document.getElementById('annivSum').textContent = aSum.toFixed(1);
 
   /* ---- íšŒê³„ì—°ë„ ê¸°ì¤€ ---- */
   const fBody=document.getElementById('fiscalBody'); clearTbody(fBody);
   let fSum=0;
 
   const firstAnniv=addYears(join,1);
-  const monthsAll=monthlyAccruals(join, leave);
+  const monthsAll=monthlyAccruals(join, leaveLimit);
   const monthsY1=monthsAll.filter(d=>d.getFullYear()===join.getFullYear());
   const monthsCarry=monthsAll.filter(d=>d.getFullYear()!==join.getFullYear());
   const monthLabel=`ë§¤ì›” ${String(join.getDate()).padStart(2,'0')}ì¼`;
 
   // 1ë…„ì°¨(ì…ì‚¬ì—°ë„ ë‚´ ì›”ì°¨)
   {
     const base=monthsY1.length*1.0;
     const [u,c]=usedCompCells(base,'fiscal-y1',isLegacy);
     fBody.appendChild(tr([ th('1ë…„ì°¨'), td(monthLabel,'yellow'), td(base.toFixed(1),'yellow right mono'), u, c ]));
     fSum += base;
   }
   // 2ë…„ì°¨ @ (ì´ì›” ì›”ì°¨)
   {
     const base=monthsCarry.length*1.0;
     const [u,c]=usedCompCells(base,'fiscal-y2carry',isLegacy);
     fBody.appendChild(tr([ th('2ë…„ì°¨ @'), td(monthLabel,'yellow'), td(base.toFixed(1),'yellow right mono'), u, c ]));
     fSum += base;
   }
   // 2ë…„ì°¨(ë¹„ë¡€ì—°ì°¨) â€” í•´ë‹¹ í•´ 1/1ì´ í‡´ì‚¬ì¼ ì´í›„ë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
   {
     const rowDate = new Date(firstAnniv.getFullYear(), 0, 1);
-    if(!leave || rowDate<=leave){
+    if(!leaveLimit || rowDate<=leaveLimit){
       const endPrevYear=new Date(join.getFullYear(),11,31);
       let prorate=0;
       if(endPrevYear>=join){
         const svcPrev=daysInclusive(join,endPrevYear);
         prorate=Math.ceil(((svcPrev/365)*15)*10)/10;
       }
       const base=prorate*1.0;
       const [u,c]=usedCompCells(base,'fiscal-y2prorate',isLegacy);
       fBody.appendChild(tr([ th('2ë…„ì°¨(ë¹„ë¡€ì—°ì°¨)'), td(fmtDate(rowDate),'yellow'), td(base.toFixed(1),'yellow right mono'), u, c ]));
       fSum += base;
     }
   }
   // 3ë…„ì°¨ë¶€í„° â€” ê° í•´ 1/1ì´ í‡´ì‚¬ì¼ ì´ì „ì¼ ë•Œë§Œ ì¶œë ¥
   {
     let displayYear = 3; // 3ë…„ì°¨ë¶€í„°
     let year = firstAnniv.getFullYear()+1; // 3ë…„ì°¨ì˜ í•´
     while(true){
       const rowDate = new Date(year,0,1);
-      if(leave && rowDate>leave) break;
+      if(leaveLimit && rowDate>leaveLimit) break;
       const days = fiscalDaysByDisplayYear(displayYear);
       const base = days*1.0;
       const [u,c]=usedCompCells(base,'fiscal-regular',isLegacy);
       fBody.appendChild(tr([ th(`${displayYear}ë…„ì°¨`), td(fmtDate(rowDate),'yellow'), td(base.toFixed(1),'yellow right mono'), u, c ]));
       fSum += base;
       displayYear++; year++;
       if(displayYear>50) break;
     }
   }
   document.getElementById('fiscalSum').textContent = fSum.toFixed(1);
 
   recalcSums();
 }
 
 document.getElementById('calcBtn').addEventListener('click', calc);
 </script>
 </body>
 </html>
 
EOF
)
