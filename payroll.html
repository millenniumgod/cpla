<!doctype html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>LISANG Lab 월 급여 계산기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --primary:#0a2a60; --bg:#f4f6fb; --card:#fff; --line:#d5d9e2; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif; background:var(--bg); }
    header { background:var(--primary); color:#fff; padding:14px 20px; display:flex; align-items:center; gap:10px; }
    .logo { width:34px; height:34px; border:2px solid rgba(255,255,255,.35); border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:12px; }
    main { max-width:1000px; margin:20px auto 50px; padding:0 16px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:18px 18px 24px; margin-bottom:16px; box-shadow:0 10px 30px rgba(0,0,0,.03); }
    h1 { font-size:20px; margin:0 0 8px; }
    label { display:block; margin:8px 0 4px; font-weight:500; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:14px; }
    input[type="text"], input[type="date"], select {
      width:100%; padding:8px 10px; border:1px solid #cfd3dd; border-radius:8px; font-size:14px; box-sizing:border-box;
    }
    input::placeholder { color:#9aa5b1; }
    button { background:var(--primary); color:#fff; border:none; border-radius:8px; padding:9px 16px; font-weight:700; cursor:pointer; margin-top:10px; }
    pre { background:#101827; color:#fff; border-radius:8px; padding:12px 14px; white-space:pre-wrap; word-break:break-all; font-size:13px; }
    .two { display:grid; grid-template-columns:1.2fr .8fr; gap:18px; }
    @media(max-width:820px){ .two{grid-template-columns:1fr;} }
    .warn { background:#fff5e5; border:1px solid #ffdc9e; padding:8px 10px; border-radius:10px; font-size:13px; }
    .muted { color:#6b7480; font-size:12px; }
  </style>
</head>
<body>
<header>
  <div class="logo">LL</div>
  <div>
    <div style="font-weight:700;">LISANG Lab</div>
    <div style="font-size:12px; opacity:.75;">월 급여 · 4대보험 · 간이세액 · 일할</div>
  </div>
</header>

<main>
  <div class="card two">
    <div>
      <h1>월 급여 계산기</h1>
      <p class="muted">엑셀은 <b>/data</b>의 <code>insurance.xlsx</code>, <code>tax.xlsx</code>를 읽습니다. (연도 갱신 시 덮어쓰기)</p>

      <div class="grid">
        <div>
          <label>기본급(과세)</label>
          <input id="base" type="text" inputmode="numeric" placeholder="예: 3,000,000" />
        </div>
        <div>
          <label>비과세(식대 등)</label>
          <input id="nontax" type="text" inputmode="numeric" placeholder="예: 200,000" />
        </div>
        <div>
          <label>공제대상 가족수</label>
          <input id="family" type="text" inputmode="numeric" placeholder="예: 1" />
        </div>
        <div>
          <label>입사일</label>
          <input id="join" type="date" />
        </div>
        <div>
          <label>퇴사일</label>
          <input id="leave" type="date" />
        </div>
        <div>
          <label>일할 기준</label>
          <select id="prorate">
            <option value="none">일할 안함</option>
            <option value="calendar">달력일수 기준</option>
            <option value="30">30일 기준</option>
            <option value="workdays">주5일(토·일 제외)</option>
          </select>
        </div>
      </div>

      <div class="grid" style="margin-top:6px;">
        <div><label><input type="checkbox" id="useNp" checked /> 국민연금</label></div>
        <div><label><input type="checkbox" id="useHi" checked /> 건강보험</label></div>
        <div><label><input type="checkbox" id="useLtc" checked /> 장기요양</label></div>
        <div><label><input type="checkbox" id="useEi" checked /> 고용보험</label></div>
      </div>

      <button id="calcBtn" type="button">계산하기</button>
      <p id="status" class="muted" style="margin-top:6px;">엑셀 로딩 중…</p>
    </div>

    <div>
      <h2 style="font-size:16px; margin-top:0;">결과</h2>
      <pre id="out">엑셀 로딩 전입니다.</pre>
      <div class="warn">
        - 건강보험·장기요양: <b>10원 절사</b> 적용<br>
        - 장기요양은 “건강보험료 × 장기요양비율”로 계산(½ 등 분할 없음)<br>
        - 간이세액표는 <b>tax.xlsx</b>의 구간·가족수 표를 그대로 사용
      </div>
    </div>
  </div>

  <p class="muted">ⓘ 참고: 실제 공단 고시/국세청 표와 다를 수 있으니 최신 수치로 엑셀을 유지하세요.</p>
</main>

<script>
/* ========== 0) 파일 경로 (권장: 파일명 고정) ========== */
const INS_XLSX_URL = "./data/insurance.xlsx";          // 4대보험 요율
const TAX_XLSX_URL = "./data/tax.xlsx";                 // 간이세액표

let INS_CONFIG = null;         // {pension:{emp}, health:{emp}, ltc:{ratio}, emp:{emp}}
let TAX_TABLE = null;          // [{min,max,taxes:[...]}]
let TAX_FAMILY_HEADERS = [];   // [1,2,3,...]

const statusEl = document.getElementById('status');
statusEl.textContent = "엑셀 불러오는 중…";

/* ========== 1) 숫자 입력: 즉시 콤마 포맷 ========== */
function onlyDigits(v){ return (v||'').replace(/[^\d]/g, ''); }
function toNumber(v){ const s = onlyDigits(v); return s ? parseInt(s,10) : 0; }
function formatComma(n){ return (n||0).toLocaleString('ko-KR'); }
function bindMoneyInput(id, def=0){
  const el = document.getElementById(id);
  el.value = def ? formatComma(def) : '';
  el.addEventListener('input', ()=>{
    const pos = el.selectionStart;
    const rawBefore = el.value;
    const digits = onlyDigits(rawBefore);
    el.value = digits ? Number(digits).toLocaleString('ko-KR') : '';
    // 커서 보정은 간단 버전(끝으로 이동)
    el.setSelectionRange(el.value.length, el.value.length);
  });
}
bindMoneyInput('base', 3000000);
bindMoneyInput('nontax', 200000);
bindMoneyInput('family', 1);

/* ========== 2) 공통 유틸 ========== */
// 10원 절사
function floor10(v){ return Math.floor(v / 10) * 10; }

async function fetchArrayBuffer(url) {
  const res = await fetch(url, {cache:'no-store'});
  if (!res.ok) throw new Error("엑셀 로드 실패: " + url);
  return await res.arrayBuffer();
}
function sheetToRows(wb) {
  const ws = wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(ws, {header:1, raw:true});
}

/* ========== 3) 4대보험 파서 ========== 
엑셀(insurance.xlsx) 예시:
B열: 항목명, C: 총요율/설명, D: 근로자요율(숫자), E: 사업주요율(선택)
- 건강보험: D열에 근로자요율(예: 0.03545)
- 장기요양: C열에 "건강보험료의 12.95%" 등 텍스트 → 비율만 추출
*/
function parseInsuranceRows(rows) {
  const headerIdx = rows.findIndex(r => r && r[1] && String(r[1]).includes("보험 항목"));
  if (headerIdx === -1) throw new Error("insurance.xlsx 헤더 행 탐지 실패");

  const result = {};
  for (let i = headerIdx + 1; i < rows.length; i++) {
    const r = rows[i];
    const name = r[1]; if (!name) continue;

    if (name.includes("국민연금")) {
      result.pension = { emp: parseFloat(r[3]) };
    } else if (name.includes("건강보험")) {
      result.health = { emp: parseFloat(r[3]) };
    } else if (name.includes("장기요양")) {
      // "건강보험료의 12.95%" → 0.1295
      let ratio = 0.1295;
      const txt = r[2];
      if (typeof txt === "string" && txt.includes("%")) {
        const m = txt.match(/([\d.]+)\s*%/);
        if (m) ratio = parseFloat(m[1]) / 100.0;
      }
      result.ltc = { ratio };
    } else if (name.includes("고용보험")) {
      result.emp = { emp: parseFloat(r[3]) };
    }
  }
  return result;
}

/* ========== 4) 간이세액표 파서 ========== 
A: 이상(천원), B: 미만(천원), C~: 가족수 1,2,3...
*/
function parseTaxRows(rows) {
  const famIdx = rows.findIndex(r => Array.isArray(r) && r.includes("공제대상가족의 수"));
  if (famIdx === -1) throw new Error("tax.xlsx에서 '공제대상가족의 수' 행 탐지 실패");

  const famRow = rows[famIdx + 1] || [];
  const families = [];
  for (let c = 2; c < famRow.length; c++) {
    if (famRow[c] != null && famRow[c] !== "") families.push(famRow[c]);
  }

  const data = [];
  for (let i = famIdx + 3; i < rows.length; i++) {
    const r = rows[i];
    if (!r) continue;
    const min = r[0], max = r[1];
    if (typeof min !== "number") continue;
    const rowObj = {
      min: Math.round(min * 1000),
      max: (typeof max === "number") ? Math.round(max * 1000) : null,
      taxes: []
    };
    for (let c = 2; c < 2 + families.length; c++) {
      const v = r[c];
      rowObj.taxes.push(typeof v === "number" ? Math.round(v) : 0);
    }
    data.push(rowObj);
  }
  return { families, data };
}

/* ========== 5) 엑셀 로드 ========== */
Promise.all([
  fetchArrayBuffer(INS_XLSX_URL).then(buf => {
    const wb = XLSX.read(buf, {type:"array"});
    INS_CONFIG = parseInsuranceRows(sheetToRows(wb));
  }).catch(e => {
    console.warn(e);
    INS_CONFIG = {
      pension:{emp:0.045}, health:{emp:0.03545}, ltc:{ratio:0.1295}, emp:{emp:0.009}
    }; // fallback
  }),
  fetchArrayBuffer(TAX_XLSX_URL).then(buf => {
    const wb = XLSX.read(buf, {type:"array"});
    const {families, data} = parseTaxRows(sheetToRows(wb));
    TAX_FAMILY_HEADERS = families;
    TAX_TABLE = data;
  }).catch(e => {
    console.warn(e);
    TAX_TABLE = null; TAX_FAMILY_HEADERS = [];
  })
]).then(()=> statusEl.textContent = "엑셀 로딩 완료. 계산할 수 있습니다.")
  .catch(()=> statusEl.textContent = "엑셀 로딩 일부 실패(기본값으로 계산).");

/* ========== 6) 날짜/일할 유틸 ========== */
function lastDayOfMonth(y,m0){ return new Date(y,m0+1,0).getDate(); }
function countWorkdays(y,m0,startD,endD){
  let cnt=0; for(let d=startD; d<=endD; d++){ const dt=new Date(y,m0,d); const day=dt.getDay(); if(day!==0 && day!==6) cnt++; }
  return cnt;
}
function proratePay(base, joinStr, leaveStr, mode){
  if (mode === "none") return base;
  const now = new Date(); const y=now.getFullYear(); const m0=now.getMonth();
  const last = lastDayOfMonth(y,m0);
  let start=1, end=last;
  if (joinStr){ const j=new Date(joinStr); if(j.getFullYear()===y && j.getMonth()===m0) start=j.getDate(); }
  if (leaveStr){ const l=new Date(leaveStr); if(l.getFullYear()===y && l.getMonth()===m0) end=l.getDate(); }
  if (start > end) return 0;

  if (mode==="calendar"){
    return Math.round(base * (end-start+1) / last);
  } else if (mode==="30"){
    return Math.round(base * (end-start+1) / 30);
  } else if (mode==="workdays"){
    const totalWd = countWorkdays(y,m0,1,last);
    const workedWd = countWorkdays(y,m0,start,end);
    return Math.round(base * workedWd / (totalWd||1));
  }
  return base;
}

/* ========== 7) 4대보험 계산(요청 반영: 건강/장기요양 10원 절사) ========== */
function calc4ins(gross, flags){
  const R = { pension:0, health:0, ltc:0, emp:0, total:0 };
  if (!INS_CONFIG) return R;

  if (flags.np && INS_CONFIG.pension?.emp) {
    // 국민연금(원 단위 반올림/절사 규정이 실무마다 달라 별도 요청 없으면 반올림)
    R.pension = Math.round(gross * INS_CONFIG.pension.emp);
  }
  if (flags.hi && INS_CONFIG.health?.emp) {
    // 건강보험: 10원 절사
    R.health = floor10(gross * INS_CONFIG.health.emp);
  }
  if (flags.ltc && INS_CONFIG.ltc?.ratio) {
    // 장기요양: 건강보험료 × 비율 → 10원 절사 (½ 같은 분할 없음)
    R.ltc = floor10(R.health * INS_CONFIG.ltc.ratio);
  }
  if (flags.ei && INS_CONFIG.emp?.emp) {
    // 고용보험(요청 없으므로 기존대로 반올림)
    R.emp = Math.round(gross * INS_CONFIG.emp.emp);
  }
  R.total = R.pension + R.health + R.ltc + R.emp;
  return R;
}

/* ========== 8) 간이세액 조회(구간/가족수 정확히 매칭) ========== */
function getWithholdingTax(monthlyTaxable, familyCount){
  if (!TAX_TABLE || TAX_TABLE.length===0) return 0;
  const row = (()=> {
    for (const r of TAX_TABLE){
      if (r.max==null){ if (monthlyTaxable >= r.min) return r; }
      else if (monthlyTaxable >= r.min && monthlyTaxable < r.max) return r;
    }
    return TAX_TABLE[TAX_TABLE.length-1];
  })();

  let idx = 0;
  if (TAX_FAMILY_HEADERS.length){
    const pos = TAX_FAMILY_HEADERS.indexOf(familyCount);
    idx = (pos>=0) ? pos : (TAX_FAMILY_HEADERS.length-1);
  }
  return row.taxes[idx] || 0;
}

/* ========== 9) 메인 계산 ========== */
document.getElementById('calcBtn').addEventListener('click', runCalc);

function runCalc(){
  const base = toNumber(document.getElementById('base').value);
  const nontax = toNumber(document.getElementById('nontax').value);
  const family = Math.max(1, toNumber(document.getElementById('family').value));
  const join = document.getElementById('join').value;
  const leave = document.getElementById('leave').value;
  const mode = document.getElementById('prorate').value;

  // 일할 반영 과세급여
  const taxableBase = proratePay(base, join, leave, mode);

  // 4대보험
  const ins = calc4ins(taxableBase, {
    np: document.getElementById('useNp').checked,
    hi: document.getElementById('useHi').checked,
    ltc: document.getElementById('useLtc').checked,
    ei: document.getElementById('useEi').checked,
  });

  // 간이세액: 과세표준(= 과세급여 - 비과세)
  const taxableForTax = Math.max(taxableBase - nontax, 0);
  const incomeTax = getWithholdingTax(taxableForTax, family);
  const localTax  = Math.round(incomeTax * 0.1);

  const totalDeduct = ins.total + incomeTax + localTax;
  const net = taxableBase + nontax - totalDeduct;

  document.getElementById('out').textContent = [
    `▶ 과세급여(일할 반영): ${formatComma(taxableBase)}원`,
    `▶ 비과세: ${formatComma(nontax)}원`,
    ``,
    `[4대보험 근로자 부담]`,
    `국민연금: ${formatComma(ins.pension)}원`,
    `건강보험: ${formatComma(ins.health)}원 (10원 절사)`,
    `장기요양: ${formatComma(ins.ltc)}원 (건강보험료 × 비율, 10원 절사)`,
    `고용보험: ${formatComma(ins.emp)}원`,
    `합계: ${formatComma(ins.total)}원`,
    ``,
    `[세금]`,
    `근로소득세(간이): ${formatComma(incomeTax)}원`,
    `지방소득세(10%): ${formatComma(localTax)}원`,
    ``,
    `총 공제: ${formatComma(totalDeduct)}원`,
    ``,
    `▶ 실수령액: ${formatComma(net)}원`,
  ].join('\n');
}
</script>
</body>
</html>
